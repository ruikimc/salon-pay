<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‰´ìš• ì‚´ë¡± ì‹¤ì‹œê°„ ê³µìœ  ê¸‰ì—¬ ì‹œìŠ¤í…œ v6.0</title>
    <style>
        :root { --border-color: #ddd; --primary: #333; --accent: #2196f3; --sunday-color: #d32f2f; }
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #333; }
        .config-area { display: flex; align-items: center; gap: 15px; }
        .staff-slots input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 85px; text-align: center; font-weight: bold; }
        
        .month-nav { display: flex; align-items: center; gap: 15px; font-size: 24px; font-weight: bold; }
        .nav-btn { cursor: pointer; padding: 5px 15px; background: #eee; border-radius: 5px; border: none; }
        .sync-indicator { font-size: 12px; color: #4caf50; font-weight: bold; margin-left: 10px; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border-top: 1px solid var(--border-color); border-left: 1px solid var(--border-color); }
        .day-header { background: #f8f9fa; padding: 10px; text-align: center; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); font-weight: bold; }
        .day-header.sun { color: var(--sunday-color); }
        .day-cell { min-height: 160px; background: #fff; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); padding: 5px; cursor: pointer; position: relative; }
        .day-num { font-weight: bold; margin-bottom: 8px; font-size: 14px; }
        .day-num.sun { color: var(--sunday-color); }
        
        .entry { font-size: 11px; background: #e3f2fd; border-left: 3px solid var(--accent); margin-bottom: 6px; padding: 4px 6px; border-radius: 3px; position: relative; }
        .entry .del-btn { position: absolute; right: 1px; top: -1px; color: #ff5252; cursor: pointer; font-size: 14px; padding: 0 3px; }
        .row-1 { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 15px; margin-bottom: 2px; }
        .entry-staff { font-weight: bold; color: #1565c0; margin-right: 3px; }
        .entry-time { color: #666; font-size: 10px; }
        .row-2 { display: block; font-weight: bold; color: #d32f2f; border-top: 1px dashed #bbdefb; padding-top: 2px; font-size: 10.5px; }

        .section-box { margin-top: 30px; padding: 20px; border-radius: 10px; border: 1px solid #ddd; }
        .weekly-report { background: #fffde7; border: 2px solid #fbc02d; }
        .stats-report { background: #f1f8e9; border: 2px solid #8bc34a; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 15px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        .english-amt { font-style: italic; color: #2e7d32; font-weight: bold; font-size: 14px; }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 25px; width: 380px; border-radius: 12px; text-align: center; }
        .modal-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .staff-btn { padding: 12px; cursor: pointer; border: 1px solid #007bff; background: #f0f7ff; color: #007bff; border-radius: 6px; font-weight: bold; }
        
        .loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:200; justify-content:center; align-items:center; font-weight:bold; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>

<div class="container">
    <div class="top-bar">
        <div class="month-nav">
            <button class="nav-btn" onclick="changeMonth(-1)">â—€</button>
            <span id="currentMonthYear"></span>
            <button class="nav-btn" onclick="changeMonth(1)">â–¶</button>
            <span id="syncStatus" class="sync-indicator">â— ì˜¨ë¼ì¸ ì—°ê²°ë¨</span>
        </div>
        <div class="config-area">
            <div class="staff-slots">
                <input type="text" id="slot1" placeholder="ì§ì›1" onchange="saveAllData()">
                <input type="text" id="slot2" placeholder="ì§ì›2" onchange="saveAllData()">
                <input type="text" id="slot3" placeholder="ì§ì›3" onchange="saveAllData()">
                <input type="text" id="slot4" placeholder="ì§ì›4" onchange="saveAllData()">
            </div>
            <div style="font-weight:bold;">ì‹œê¸‰: <input type="number" step="0.01" id="hourlyRate" value="17" onchange="saveAllData()" style="width:60px; padding:5px; text-align:center;">$</div>
            <button onclick="loadFromCloud()" style="padding:8px; cursor:pointer; background:#2196f3; color:white; border:none; border-radius:4px; font-size:12px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>

    <div class="calendar-grid" id="calendarGrid"></div>

    <div class="section-box weekly-report">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin:0;">âœï¸ ìˆ˜í‘œ ì‘ì„±ìš© ì£¼ê°„ ì •ì‚°</h3>
            <div>
                ë§ˆì§€ë§‰ ë‚ ì§œ: <input type="date" id="reportEndDate">
                <button onclick="calculateWeeklyReport()" style="padding:10px 20px; cursor:pointer; background:#333; color:white; border:none; border-radius:6px; font-weight:bold;">ê³„ì‚°í•˜ê¸°</button>
            </div>
        </div>
        <div id="weeklyOutput">ë‚ ì§œ ì„ íƒ í›„ ê³„ì‚° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</div>
    </div>

    <div class="section-box stats-report">
        <h3 style="margin:0;">ğŸ“ˆ ì‹¤ì‹œê°„ í†µê³„ (ì›”ê°„/ëˆ„ì )</h3>
        <div id="statsOutput"></div>
    </div>
</div>

<div id="staffModal" class="modal">
    <div class="modal-content">
        <h3 id="modalDateTitle"></h3>
        <p>ê·¼ë¬´í•œ ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”:</p>
        <div class="modal-btns" id="staffBtnGroup"></div>
        <button onclick="closeModal()" style="margin-top:20px; width:100%; padding:10px; border:none; background:#eee; border-radius:6px;">ì·¨ì†Œ</button>
    </div>
</div>

<script>
    // ì‚¬ì¥ë‹˜ì˜ êµ¬ê¸€ ì›¹ ì•± URL (ë°ì´í„° ì°½ê³  ì£¼ì†Œ)
    const CLOUD_URL = "https://script.google.com/macros/s/AKfycby1zCohY5-soMyvA2T9b5evPtCQrhAy36L3Z4ooJdETeQP4BUXb6On_KWDJg3s7jxCs/exec";

    let currentDate = new Date();
    let workData = {};
    let staffNames = ["", "", "", ""];
    let hourlyRate = 17;
    let activeDateStr = "";

    async function init() {
        await loadFromCloud();
        renderCalendar();
        updateStats();
    }

    // êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë¶ˆëŸ¬ì˜¤ê¸°)
    async function loadFromCloud() {
        document.getElementById('loading').style.display = 'flex';
        try {
            const response = await fetch(CLOUD_URL);
            const json = await response.json();
            if (json) {
                workData = json.workData || {};
                staffNames = json.staffNames || ["", "", "", ""];
                hourlyRate = json.hourlyRate || 17;
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                document.getElementById('hourlyRate').value = hourlyRate;
                staffNames.forEach((name, i) => { if(document.getElementById(`slot${i+1}`)) document.getElementById(`slot${i+1}`).value = name; });
                renderCalendar();
                updateStats();
                document.getElementById('syncStatus').innerText = "â— ì˜¨ë¼ì¸ ë™ê¸°í™” ì™„ë£Œ";
            }
        } catch (e) {
            console.error("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
            document.getElementById('syncStatus').innerText = "â—‹ ì˜¤í”„ë¼ì¸ ëª¨ë“œ (ì—°ê²° ì‹¤íŒ¨)";
        }
        document.getElementById('loading').style.display = 'none';
    }

    // êµ¬ê¸€ ì‹œíŠ¸ì— ë°ì´í„° ì €ì¥í•˜ê¸° (ë³´ë‚´ê¸°)
    async function saveAllData() {
        document.getElementById('loading').style.display = 'flex';
        staffNames = [
            document.getElementById('slot1').value, 
            document.getElementById('slot2').value, 
            document.getElementById('slot3').value, 
            document.getElementById('slot4').value
        ];
        hourlyRate = document.getElementById('hourlyRate').value;

        const payload = {
            workData: workData,
            staffNames: staffNames,
            hourlyRate: hourlyRate
        };

        try {
            await fetch(CLOUD_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            document.getElementById('syncStatus').innerText = "â— ë°ì´í„° ì €ì¥ë¨";
        } catch (e) {
            alert("ì €ì¥ ì‹¤íŒ¨! ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.");
        }
        document.getElementById('loading').style.display = 'none';
        renderCalendar();
        updateStats();
    }

    function changeMonth(delta) { currentDate.setMonth(currentDate.getMonth() + delta); renderCalendar(); updateStats(); }

    function formatShortTime(range) {
        try {
            const format = (t) => {
                let [h, m] = t.split(':').map(Number);
                const p = h >= 12 || h < 9 ? "P" : "A";
                return `${p}${h}:${m ? String(m).padStart(2,'0') : '00'}`;
            };
            const pts = range.split('-');
            return `${format(pts[0])}-${format(pts[1])}`;
        } catch { return range; }
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        document.getElementById('currentMonthYear').innerText = `${year}ë…„ ${month + 1}ì›”`;
        const grid = document.getElementById('calendarGrid'); grid.innerHTML = "";
        const headers = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
        headers.forEach((h, i) => grid.innerHTML += `<div class="day-header ${i===0?'sun':''}">${h}</div>`);
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="day-cell"></div>`;
        for (let d = 1; d <= lastDate; d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const entries = workData[dateStr] || [];
            const isSun = new Date(year, month, d).getDay() === 0;
            let html = `<div class="day-cell" onclick="openStaffModal('${dateStr}')"><div class="day-num ${isSun?'sun':''}">${d}</div>`;
            entries.forEach((e, idx) => {
                html += `<div class="entry">
                    <span class="del-btn" onclick="event.stopPropagation(); deleteEntry('${dateStr}', ${idx})">Ã—</span>
                    <span class="row-1"><span class="entry-staff">${e.name}</span><span class="entry-time">${formatShortTime(e.timeRange)}</span></span>
                    <span class="row-2">TOTAL: ${e.hours.toFixed(1)}h</span>
                </div>`;
            });
            grid.innerHTML += html + `</div>`;
        }
    }

    function updateStats() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1;
        const prefix = `${year}-${String(month).padStart(2,'0')}`;
        const rate = parseFloat(hourlyRate);
        let mStats = {}, tStats = {};
        for (let date in workData) {
            workData[date].forEach(e => {
                tStats[e.name] = (tStats[e.name] || 0) + e.hours;
                if (date.startsWith(prefix)) mStats[e.name] = (mStats[e.name] || 0) + e.hours;
            });
        }
        let html = `<table><tr><th>ì§ì›ëª…</th><th>${month}ì›” ì´ ì‹œê°„</th><th>${month}ì›” ì´ ê¸‰ì—¬</th><th>ì „ì²´ ëˆ„ì  ì‹œê°„</th><th>ì „ì²´ ëˆ„ì  ê¸‰ì—¬</th></tr>`;
        staffNames.forEach(name => {
            if (!name || !name.trim()) return;
            const mh = mStats[name] || 0, th = tStats[name] || 0;
            html += `<tr><td><strong>${name}</strong></td><td>${mh.toFixed(2)}h</td><td>$ ${(mh * rate).toLocaleString()}</td><td>${th.toFixed(2)}h</td><td>$ ${(th * rate).toLocaleString()}</td></tr>`;
        });
        document.getElementById('statsOutput').innerHTML = html + `</table>`;
    }

    function openStaffModal(dateStr) {
        activeDateStr = dateStr; document.getElementById('modalDateTitle').innerText = dateStr;
        const btnGroup = document.getElementById('staffBtnGroup'); btnGroup.innerHTML = "";
        staffNames.forEach(name => {
            if(!name || !name.trim()) return;
            const btn = document.createElement('button'); btn.className = 'staff-btn'; btn.innerText = name;
            btn.onclick = () => {
                closeModal();
                const tr = prompt(`${name} ì‹œê°„ (ì˜ˆ: 10-6:30):`, "10-6:30"); if(!tr) return;
                const lunch = confirm("ì ì‹¬(30ë¶„) ì°¨ê°?");
                const pts = tr.split('-'); const s = parseT(pts[0]); const e = parseT(pts[1]);
                const hrs = Math.max(0, (e-s) - (lunch?0.5:0));
                if(!workData[activeDateStr]) workData[activeDateStr] = [];
                workData[activeDateStr].push({ name, timeRange: tr, hours: hrs });
                saveAllData();
            };
            btnGroup.appendChild(btn);
        });
        document.getElementById('staffModal').style.display = 'block';
    }
    function parseT(t) { let [h, m] = t.split(':').map(Number); if(h<9) h+=12; return h+(m||0)/60; }
    function closeModal() { document.getElementById('staffModal').style.display = 'none'; }
    function deleteEntry(d, i) { workData[d].splice(i, 1); saveAllData(); }

    function calculateWeeklyReport() {
        const endStr = document.getElementById('reportEndDate').value;
        if (!endStr) return alert("ë‚ ì§œ ì„ íƒ!");
        let end = new Date(endStr + "T12:00:00");
        let sum = {}; const rate = parseFloat(hourlyRate);
        for (let i = 0; i < 7; i++) {
            let d = new Date(end); d.setDate(d.getDate() - i);
            let ds = d.toISOString().split('T')[0];
            if (workData[ds]) workData[ds].forEach(e => { sum[e.name] = (sum[e.name] || 0) + e.hours; });
        }
        let h = `<table><tr><th>ì§ì›</th><th>ì‹œê°„</th><th>ê¸°ë³¸ê¸‰</th><th>OT(1.5x)</th><th>ì´ ì§€ê¸‰ì•¡</th><th>Check Writing (ì˜ë¬¸)</th></tr>`;
        for (let n in sum) {
            let t = sum[n], b = Math.min(40, t), o = Math.max(0, t-40), p = (b*rate)+(o*rate*1.5);
            h += `<tr><td>${n}</td><td>${t.toFixed(2)}h</td><td>$${(b*rate).toFixed(2)}</td><td>$${(o*rate*1.5).toFixed(2)}</td><td><strong>$${p.toFixed(2)}</strong></td><td class="english-amt">${numToWordsWithCents(p)}</td></tr>`;
        }
        document.getElementById('weeklyOutput').innerHTML = h + `</table>`;
    }

    function numToWordsWithCents(amount) {
        const a = ['','ONE ','TWO ','THREE ','FOUR ','FIVE ','SIX ','SEVEN ','EIGHT ','NINE ','TEN ','ELEVEN ','TWELVE ','THIRTEEN ','FOURTEEN ','FIFTEEN ','SIXTEEN ','SEVENTEEN ','EIGHTEEN ','NINETEEN '];
        const b = ['', '', 'TWENTY','THIRTY','FORTY','FIFTY','SIXTY','SEVENTY','EIGHTY','NINETY'];
        let dollars = Math.floor(amount);
        let cents = Math.round((amount - dollars) * 100);
        function convert(num) {
            let res = "";
            if (num >= 100) { res += a[Math.floor(num/100)] + "HUNDRED "; num %= 100; }
            if (num < 20) res += a[num];
            else res += b[Math.floor(num/10)] + "-" + a[num%10];
            return res.trim();
        }
        let dollarWords = dollars === 0 ? "ZERO" : convert(dollars);
        let centWords = cents.toString().padStart(2, '0') + "/100";
        return `${dollarWords} AND ${centWords}`;
    }

    init();
</script>
</body>
</html>