<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‰´ìš• ì‚´ë¡± ê¸‰ì—¬ ê´€ë¦¬ ì‹œìŠ¤í…œ v8.1</title>
    <style>
        :root { --border-color: #ddd; --primary: #333; --accent: #2196f3; --sunday-color: #d32f2f; }
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1350px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid #333; }
        .config-area { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .staff-slots { display: flex; gap: 5px; }
        .staff-slots input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 75px; text-align: center; font-weight: bold; }
        .month-nav { display: flex; align-items: center; gap: 15px; font-size: 24px; font-weight: bold; }
        .nav-btn { cursor: pointer; padding: 5px 15px; background: #eee; border-radius: 5px; border: none; }
        .sync-indicator { font-size: 12px; color: #4caf50; font-weight: bold; margin-left: 10px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border-top: 1px solid var(--border-color); border-left: 1px solid var(--border-color); }
        .day-header { background: #f8f9fa; padding: 10px; text-align: center; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); font-weight: bold; }
        .day-header.sun { color: var(--sunday-color); }
        .day-cell { min-height: 180px; background: #fff; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); padding: 5px; cursor: pointer; }
        .day-num { font-weight: bold; margin-bottom: 8px; font-size: 14px; }
        .day-num.sun { color: var(--sunday-color); }
        
        /* ìƒì„¸ ì‹œê°„ í‘œì‹œ ë³µêµ¬ */
        .entry { font-size: 11px; background: #e3f2fd; border-left: 3px solid var(--accent); margin-bottom: 6px; padding: 4px; border-radius: 3px; position: relative; }
        .entry .del-btn { position: absolute; right: 1px; top: -1px; color: #ff5252; cursor: pointer; font-size: 14px; padding: 0 3px; }
        .row-1 { display: block; font-weight: bold; color: #1565c0; margin-bottom: 2px; }
        .row-2 { display: block; font-size: 10px; color: #666; font-style: italic; }
        .row-3 { display: block; font-weight: bold; color: #d32f2f; border-top: 1px dashed #bbdefb; padding-top: 1px; margin-top: 2px; }

        .section-box { margin-top: 30px; padding: 20px; border-radius: 10px; border: 1px solid #ddd; }
        .weekly-report { background: #fffde7; border: 2px solid #fbc02d; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 15px; table-layout: fixed; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; word-break: break-all; }
        .english-amt { font-style: italic; color: #2e7d32; font-weight: bold; font-size: 13px; text-align: left; padding-left: 15px; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 25px; width: 400px; border-radius: 12px; text-align: center; }
        .modal-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
        .staff-btn { padding: 10px; cursor: pointer; border: 1px solid #007bff; background: #f0f7ff; color: #007bff; border-radius: 6px; font-weight: bold; font-size: 13px; }
        .loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:200; justify-content:center; align-items:center; font-weight:bold; }
    </style>
</head>
<body>
<div id="loading" class="loading-overlay">ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
<div class="container">
    <div class="top-bar">
        <div class="month-nav">
            <button class="nav-btn" onclick="changeMonth(-1)">â—€</button>
            <span id="currentMonthYear"></span>
            <button class="nav-btn" onclick="changeMonth(1)">â–¶</button>
            <span id="syncStatus" class="sync-indicator">â— ì—°ê²°ë¨</span>
        </div>
        <div class="config-area">
            <div class="staff-slots">
                <input type="text" id="slot1" placeholder="1" onchange="saveAllData()">
                <input type="text" id="slot2" placeholder="2" onchange="saveAllData()">
                <input type="text" id="slot3" placeholder="3" onchange="saveAllData()">
                <input type="text" id="slot4" placeholder="4" onchange="saveAllData()">
                <input type="text" id="slot5" placeholder="5" onchange="saveAllData()">
                <input type="text" id="slot6" placeholder="6" onchange="saveAllData()">
            </div>
            <div style="font-weight:bold;">ì‹œê¸‰: <input type="number" step="0.01" id="hourlyRate" value="17" onchange="saveAllData()" style="width:55px; padding:5px;">$</div>
            <button onclick="loadFromCloud()" style="padding:8px 12px; cursor:pointer; background:#2196f3; color:white; border:none; border-radius:4px; font-size:12px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
    <div class="section-box weekly-report">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin:0;">âœï¸ ìˆ˜í‘œ ì‘ì„±ìš© ì •ì‚°</h3>
            <div>ë§ˆì§€ë§‰ ë‚ : <input type="date" id="reportEndDate"> <button onclick="calculateWeeklyReport()" style="padding:10px 20px; cursor:pointer; background:#333; color:white; border:none; border-radius:6px; font-weight:bold;">ì£¼ê¸‰ ê³„ì‚°</button></div>
        </div>
        <div id="weeklyOutput"></div>
    </div>
</div>

<div id="staffModal" class="modal"><div class="modal-content"><h3 id="modalDateTitle"></h3><p>ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”:</p><div class="modal-btns" id="staffBtnGroup"></div><button onclick="closeModal()" style="margin-top:20px; width:100%; padding:10px; border:none; background:#eee; border-radius:6px;">ì·¨ì†Œ</button></div></div>

<script>
    // ì‚¬ì¥ë‹˜ì˜ ê³ ìœ  ì£¼ì†Œë¥¼ ë‹¤ì‹œ ë„£ì—ˆìŠµë‹ˆë‹¤.
    const CLOUD_URL = "https://script.google.com/macros/s/AKfycby1zCohY5-soMyvA2T9b5evPtCQrhAy36L3Z4ooJdETeQP4BUXb6On_KWDJg3s7jxCs/exec";

    let currentDate = new Date();
    let workData = {}; let staffNames = ["", "", "", "", "", ""]; let hourlyRate = 17;

    async function init() { await loadFromCloud(); renderCalendar(); }
    
    async function loadFromCloud() {
        document.getElementById('loading').style.display = 'flex';
        try {
            const response = await fetch(CLOUD_URL); const json = await response.json();
            if (json) {
                workData = json.workData || {}; staffNames = json.staffNames || ["", "", "", "", "", ""]; hourlyRate = json.hourlyRate || 17;
                document.getElementById('hourlyRate').value = hourlyRate;
                staffNames.forEach((name, i) => { if(document.getElementById(`slot${i+1}`)) document.getElementById(`slot${i+1}`).value = name; });
                renderCalendar(); document.getElementById('syncStatus').innerText = "â— ì˜¨ë¼ì¸ ë™ê¸°í™” ì™„ë£Œ";
            }
        } catch (e) { document.getElementById('syncStatus').innerText = "â—‹ ì—°ê²° ì•ˆë¨"; }
        document.getElementById('loading').style.display = 'none';
    }

    async function saveAllData() {
        document.getElementById('loading').style.display = 'flex';
        staffNames = [document.getElementById('slot1').value, document.getElementById('slot2').value, document.getElementById('slot3').value, document.getElementById('slot4').value, document.getElementById('slot5').value, document.getElementById('slot6').value];
        hourlyRate = document.getElementById('hourlyRate').value;
        const payload = { workData, staffNames, hourlyRate };
        try { await fetch(CLOUD_URL, { method: "POST", body: JSON.stringify(payload) }); document.getElementById('syncStatus').innerText = "â— ì €ì¥ë¨"; } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨!"); }
        document.getElementById('loading').style.display = 'none'; renderCalendar();
    }

    function changeMonth(delta) { currentDate.setMonth(currentDate.getMonth() + delta); renderCalendar(); }
    
    function renderCalendar() {
        const year = currentDate.getFullYear(); const month = currentDate.getMonth();
        document.getElementById('currentMonthYear').innerText = `${year}ë…„ ${month + 1}ì›”`;
        const grid = document.getElementById('calendarGrid'); grid.innerHTML = "";
        const headers = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
        headers.forEach((h, i) => grid.innerHTML += `<div class="day-header ${i===0?'sun':''}">${h}</div>`);
        const firstDay = new Date(year, month, 1).getDay(); const lastDate = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="day-cell"></div>`;
        for (let d = 1; d <= lastDate; d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const entries = workData[dateStr] || []; const isSun = new Date(year, month, d).getDay() === 0;
            let html = `<div class="day-cell" onclick="openStaffModal('${dateStr}')"><div class="day-num ${isSun?'sun':''}">${d}</div>`;
            entries.forEach((e, idx) => { 
                html += `<div class="entry">
                    <span class="del-btn" onclick="event.stopPropagation(); deleteEntry('${dateStr}', ${idx})">Ã—</span>
                    <span class="row-1">${e.name}</span>
                    <span class="row-2">${e.timeRange || ''}</span>
                    <span class="row-3">${e.hours.toFixed(1)}h</span>
                </div>`; 
            });
            grid.innerHTML += html + `</div>`;
        }
    }

    function openStaffModal(dateStr) {
        activeDateStr = dateStr; document.getElementById('modalDateTitle').innerText = dateStr;
        const btnGroup = document.getElementById('staffBtnGroup'); btnGroup.innerHTML = "";
        staffNames.forEach(name => {
            if(!name || !name.trim()) return;
            const btn = document.createElement('button'); btn.className = 'staff-btn'; btn.innerText = name;
            btn.onclick = () => {
                closeModal(); const tr = prompt(`${name} ì‹œê°„ (ì˜ˆ: 10-6:30):`, "10-6:30"); if(!tr) return;
                const lunch = confirm("ì ì‹¬(30ë¶„) ì°¨ê°?"); const pts = tr.split('-'); const s = parseT(pts[0]); const e = parseT(pts[1]);
                const hrs = Math.max(0, (e-s) - (lunch?0.5:0));
                if(!workData[activeDateStr]) workData[activeDateStr] = [];
                workData[activeDateStr].push({ name, hours: hrs, timeRange: tr });
                saveAllData();
            };
            btnGroup.appendChild(btn);
        });
        document.getElementById('staffModal').style.display = 'block';
    }

    function parseT(t) { let [h, m] = t.split(':').map(Number); if(h<9) h+=12; return h+(m||0)/60; }
    function closeModal() { document.getElementById('staffModal').style.display = 'none'; }
    function deleteEntry(d, i) { workData[d].splice(i, 1); saveAllData(); }

    function calculateWeeklyReport() {
        const endStr = document.getElementById('reportEndDate').value; if (!endStr) return alert("ë‚ ì§œ ì„ íƒ!");
        let end = new Date(endStr + "T12:00:00"); let sum = {}; const rate = parseFloat(hourlyRate);
        for (let i = 0; i < 7; i++) { let d = new Date(end); d.setDate(d.getDate() - i); let ds = d.toISOString().split('T')[0]; if (workData[ds]) workData[ds].forEach(e => { sum[e.name] = (sum[e.name] || 0) + e.hours; }); }
        let h = `<table><tr><th style="width:15%">ì§ì›</th><th style="width:15%">ì‹œê°„</th><th style="width:15%">ì´ì•¡</th><th style="width:55%">Check Writing (English)</th></tr>`;
        for (let n in sum) { let t = sum[n], b = Math.min(40, t), o = Math.max(0, t-40), p = (b*rate)+(o*rate*1.5); h += `<tr><td>${n}</td><td>${t.toFixed(1)}h</td><td>$${p.toFixed(2)}</td><td class="english-amt">${numToWordsWithCents(p)}</td></tr>`; }
        document.getElementById('weeklyOutput').innerHTML = h + `</table>`;
    }

    function numToWordsWithCents(amount) {
        const a = ['','one ','two ','three ','four ','five ','six ','seven ','eight ','nine ','ten ','eleven ','twelve ','thirteen ','fourteen ','fifteen ','sixteen ','seventeen ','eighteen ','nineteen '];
        const b = ['', '', 'twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];
        let dollars = Math.floor(amount); let cents = Math.round((amount - dollars) * 100);
        function convert(num) {
            let res = ""; if (num >= 100) { res += a[Math.floor(num/100)] + "hundred "; num %= 100; }
            if (num < 20) res += a[num]; else { res += b[Math.floor(num/10)]; if(num%10>0) res += "-" + a[num%10]; else res += " "; }
            return res;
        }
        let dollarWords = dollars === 0 ? "zero " : convert(dollars); let centWords = cents.toString().padStart(2, '0') + "/100";
        return (dollarWords + "and " + centWords).trim();
    }
    init();
</script>
</body>
</html>
